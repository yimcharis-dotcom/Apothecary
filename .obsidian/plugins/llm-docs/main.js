/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var I=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var ue=Object.prototype.hasOwnProperty;var me=(i,s)=>{for(var e in s)I(i,e,{get:s[e],enumerable:!0})},ge=(i,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of pe(s))!ue.call(i,n)&&n!==e&&I(i,n,{get:()=>s[n],enumerable:!(t=de(s,n))||t.enumerable});return i};var he=i=>ge(I({},"__esModule",{value:!0}),i);var Pe={};me(Pe,{default:()=>O});module.exports=he(Pe);var m=require("obsidian");var L=require("obsidian");var V=require("events");async function $(i){let s=await fetch(`${i.baseUrl}/v1/models`,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.apiKey}`}});return await j(s),(await s.json()).data.map(t=>t.id)}var M=class extends V.EventEmitter{constructor(e,t,n){super();this.settings=e;this.model=t;this.messages=n}entireContent="";abortController;result(){return new Promise((e,t)=>{this.on("error",n=>t(n)),this.on("end",()=>e(this.entireContent)),this.start()})}async start(){try{await this.doRequest()}catch(e){e.name!=="AbortError"&&this.emit("error",e)}finally{this.emit("end"),this.removeAllListeners()}}async doRequest(){let e=JSON.stringify({model:this.model,messages:this.messages,stream:!0});this.abortController=new AbortController;let t=await fetch(`${this.settings.baseUrl}/v1/chat/completions`,{method:"POST",body:e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},signal:this.abortController.signal});await j(t);let o=t.body.getReader(),r=new TextDecoder("utf-8"),a=!1;for(;!a;){let{done:l,value:d}=await o.read();if(a=l,d){let p=r.decode(d,{stream:!0}),c=this.parseChunkForContent(p);c&&(this.entireContent+=c,this.emit("data",c))}}}parseChunkForContent(e){return e.toString().split(`
`).map(t=>{if(t.startsWith("data: ")){let n=t.slice(6);try{return JSON.parse(n)?.choices[0]?.delta?.content}catch{return}}}).filter(t=>t!==void 0).join("")}stop(){this.abortController?.abort()}};async function j(i){if(i.ok)return;let s;try{s=await i.json()}catch{throw new Error(`${i.status} ${i.statusText}`)}let e=s.error;throw e.code==="invalid_api_key"?new Error("Invalid OpenAI API key"):e.message.startsWith("You didn't provide an API key")?new Error("You must provide an OpenAI API key"):new Error(e.message)}function H(i,s){let e=new RegExp(s),t=[],n,o=0;for(;(n=e.exec(i))!==null;){let{index:a}=n;if(a===void 0)throw new Error("Index was undefined in splitKeepingSeparators()");let l=i.substring(o,n.index);l&&t.push({text:l});let d=n[0];t.push({text:d,isSeparator:!0,innerMatch:n[1]}),o=e.lastIndex}let r=i.substring(o);return r&&t.push({text:r}),t}var w=class{listeners=new Set;on(s){return this.listeners.add(s),()=>this.off(s)}off(s){this.listeners.delete(s)}once(s){let e=t=>{this.off(e),s(t)};return this.on(e)}emit(s){for(let e of this.listeners)e(s)}};function K(i){let s=i.split(`
`),e=null,t=[],n=[];for(let o of s){let r=null;o==="# system"&&(r="system"),o==="# user"&&(r="user"),o==="# assistant"&&(r="assistant"),r?(e&&n.push({role:e,content:t.join(`
`)}),t=[],e=r):t.push(o)}return e&&n.push({role:e,content:t.join(`
`)}),n.length||n.push({role:"user",content:i}),n}function _(i){return i.map(e=>`# ${e.role}
${e.content}`).join(`
`)}async function z(i,s,e){let n=i.filter(o=>!(o.role==="system"&&/^\s*$/.test(o.content))).map(async o=>{if(o.role==="assistant")return o;let r=await we(o.content,s),a=await fe(r,e);return{...o,content:a}});return Promise.all(n)}async function fe(i,s){let e=W(i).map(async n=>{let o={type:"text",text:n.text};if(n.isSeparator){let r=await s(n.innerMatch);return r?{type:"image_url",image_url:{url:r}}:o}return o}),t=await Promise.all(e);return t.some(n=>n.type==="image_url")?t:i}async function we(i,s){let e=W(i).map(async t=>t.isSeparator?await s(t.innerMatch)??t.text:t.text);return(await Promise.all(e)).join("")}var W=i=>H(i,/!?\[\[(.+?)]]/g);var Y={docsDir:"LLM",connections:[],pinnedModels:{},defaults:{model:"gpt-4o",systemPrompt:"",docOpenMethod:"tab"}};var ye=["png","jpg","jpeg","gif"],Ce=["txt","md","markdown","html"];function G(i,s=""){return async function(t){let n=i.metadataCache.getFirstLinkpathDest(t,s);return!n||!Ce.includes(n.extension)?null:i.vault.cachedRead(n)}}function q(i,s=""){return async function(t){let n=i.metadataCache.getFirstLinkpathDest(t,s);if(!n||!ye.includes(n.extension))return null;let o=await i.vault.readBinary(n),r=Buffer.from(o).toString("base64");return`data:image/${n.extension==="jpg"?"jpeg":n.extension};base64,${r}`}}function J(i,s){switch(s){case"replace":return i.getLeaf();case"tab":return i.getLeaf("tab");case"splitVertical":return i.getLeaf("split","vertical");case"splitHorizontal":return i.getLeaf("split","horizontal");case"window":return i.getLeaf("window");default:return i.getLeaf("tab")}}var Q=require("events");var k=new Set,C=new Q.EventEmitter;function x(i){return k.has(i)}function X(i){k.add(i),C.emit("change")}function Z(i){k.delete(i),C.emit("change")}var ee,te=()=>ee,ne=i=>ee=i,v=new w;var b=new Map;function S(i){return i.type+i.baseUrl}async function B(i){let s=S(i),e=await $(i),t=!1;for(let n of e){let o=b.get(n);(!o||o!==s)&&(b.set(n,s),t=!0)}t&&v.emit()}async function F(i){let s=i.map(e=>B(e).catch(()=>{}));await Promise.all(s)}function se(i,s){let e=b.get(s);if(e){let t=i.find(n=>S(n)===e);if(t)return t}return null}async function ie(i,s){let e=se(i,s);return e||(await F(i),se(i,s))}var xe=M,g=class{constructor(s,e,t,n){this.app=s;this.file=e;this.messages=t;this.properties=n}currentStream=null;static async fromFile(s,e,t){let n=await s.vault.read(e),o=(0,L.getFrontMatterInfo)(n),r=o.exists?(0,L.parseYaml)(o.frontmatter):{},a={model:t.model,...r},l=n.slice(o.contentStart),d=K(l);return new g(s,e,d,a)}static async create(s,e,t,n){let o=_(n),r=await s.vault.create(e,o);return await s.fileManager.processFrontMatter(r,a=>{a.model=t.model}),new g(s,r,n,t)}async stop(){this.currentStream?.stop()}async complete(s,e){let t=await ie(s,this.properties.model);if(!t)throw new Error(`No connection found for model "${this.properties.model}"`);await this.app.fileManager.processFrontMatter(this.file,r=>{r.model=this.properties.model});let n=new xe(t,this.properties.model,await z(this.messages,G(this.app,this.file.path),q(this.app,this.file.path)));this.currentStream=n;let o=!1;n.on("data",r=>{o||(this.app.vault.append(this.file,`
# assistant
`),o=!0),this.app.vault.append(this.file,r)}),await n.result(),await this.app.vault.append(this.file,`
# user
`),await sleep(10),e.setCursor({line:e.lastLine(),ch:0})}};var u=require("@codemirror/view"),oe=require("@codemirror/state"),P=require("obsidian");var R=class{constructor(s){this.view=s;this.rebuild()}decorations;cursorCanBeObscured;update(s){let e=this.cursorCanBeObscured;if(s.selectionSet)if(this.view.cm?.state?.vim?.insertMode===!1){let{doc:n,selection:o}=this.view.state;e=n.length-o.main.to===0}else e=!1;(s.docChanged||s.viewportChanged||e!==this.cursorCanBeObscured)&&(this.cursorCanBeObscured=e,this.rebuild())}rebuild(){this.decorations=this.buildDecorations()}buildDecorations(){if(!this.enabled())return u.Decoration.none;let{state:s,viewport:e}=this.view,{doc:t}=s,{file:n,editor:o}=s.field(P.editorInfoField);if(!n||!o)return console.error("Could not decorate: missing file or editor",{file:n,editor:o}),u.Decoration.none;let r=new oe.RangeSetBuilder,a=t.lineAt(e.from),l=t.lineAt(e.to),d=a.from,p=null;for(let c of t.iterLines(a.number,l.number+1))c.startsWith("# ")&&(c==="# system"?(p=null,r.add(d,d+c.length,u.Decoration.mark({class:"llmdocs-heading-system"}))):c==="# user"?(p=d+c.length,r.add(d,p,u.Decoration.mark({class:"llmdocs-heading-user"}))):c==="# assistant"&&(p=d+c.length,r.add(d,p,u.Decoration.mark({class:"llmdocs-heading-assistant"})))),d+=c.length+1;if(this.shouldAddFooter(t,e,n,p)){let c=t.line(t.lines);r.add(c.to,c.to,u.Decoration.widget({widget:new U(o,n,this),side:1}))}return r.finish()}shouldAddFooter(s,e,t,n){return s.length>e.to?!1:x(t)||!n?!0:!(!s.sliceString(n).trim()||this.cursorCanBeObscured)}enabled(){let s=this.view.state.doc.iterLines();if(s.next().value!=="---")return!1;for(let e of s){if(e.startsWith("model:"))return!0;if(e==="---")return!1}return!1}destroy(){}},U=class extends u.WidgetType{constructor(e,t,n){super();this.editor=e;this.file=t;this.plugin=n;this.onEvent=this.onEvent.bind(this),this.button=document.createElement("button"),this.loadingIndicator=document.createElement("span")}button;loadingIndicator;toDOM(e){let t=document.createElement("span");t.className="llmdocs-footer";let n=this.button;n.innerText="Complete",n.className="llmdocs-complete-button",n.onclick=async()=>{this.editor.focus(),await te().completeDoc(this.editor,this.file)};let o=this.loadingIndicator;return o.append((0,P.getIcon)("bot")),o.className="llmdocs-loading-indicator",this.onEvent(!0),C.on("change",this.onEvent),t.append(n,o),t}onEvent(e){x(this.file)?(this.button.hide(),this.loadingIndicator.show()):(this.loadingIndicator.hide(),e||this.plugin.rebuild())}destroy(e){C.off("change",this.onEvent),super.destroy(e)}},be={decorations:i=>i.decorations},re=u.ViewPlugin.fromClass(R,be);var h=require("obsidian");var f=require("obsidian");function ae(i,s,e){new f.Setting(i).setName("Connections").setDesc("Use official OpenAI/Anthropic APIs, or a compatible self-hosted alternative").setHeading();let t=i.createDiv();s.settings.connections.forEach((n,o)=>{let r=new f.Setting(t).setName(`#${o+1}`);r.addDropdown(a=>{a.addOptions({OpenAI:"OpenAI"}).setValue(n.type).onChange(async l=>{s.settings.connections[o].type=l,await s.saveSettings()})}),r.addText(a=>a.setPlaceholder("Base URL").setValue(n.baseUrl).onChange(async l=>{s.settings.connections[o].baseUrl=l,await s.saveSettings()})),r.addText(a=>a.setPlaceholder("API key").setValue(n.apiKey).onChange(async l=>{s.settings.connections[o].apiKey=l,await s.saveSettings()})),r.addButton(a=>{a.setButtonText("Test").onClick(async()=>{a.setDisabled(!0);try{await B(n),new f.Notice("Connection success!")}catch(l){new f.Notice(l)}a.setDisabled(!1)})}),r.addButton(a=>{a.setButtonText("Remove").onClick(async()=>{s.settings.connections.splice(o,1),await s.saveSettings(),e()})})}),new f.Setting(i).addButton(n=>{n.setButtonText("Add connection").onClick(async()=>{s.settings.connections.push({baseUrl:"https://api.openai.com",apiKey:"",type:"OpenAI"}),await s.saveSettings(),e()})})}var D=require("obsidian");var y=class extends D.SuggestModal{constructor(e,t){super(e);this.plugin=t;this.refreshModels(),this.emptyStateText=this.getEmptyStateText(),this.setPlaceholder("Select a model...")}models;onResult=new w;unsubscribe=v.on(()=>{this.refreshModels()});async openAndGetResult(){return new Promise(e=>{this.open(),this.onResult.once(t=>{e(t)})})}refreshModels(){let e=new Intl.Collator;this.models=Se(this.plugin.settings).sort((t,n)=>e.compare(le(t),le(n))),this.updateSuggestions()}getEmptyStateText(){return this.plugin.settings.connections.length?"Loading...":"No results. You need to add a connection first!"}getSuggestions(e){return this.models.filter(t=>t.name.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){let n=t.createEl("div",{cls:"llmdocs-suggest-item-pin"});n.onclick=async o=>{o.stopPropagation(),await this.togglePinned(e)},e.isPinned&&n.addClass("pinned"),n.append((0,D.getIcon)("pin")),t.createEl("div",{text:e.name,cls:"llmdocs-suggest-item-title"}),t.createEl("small",{text:e.connectionUrl,cls:"llmdocs-suggest-item-subtext"})}async togglePinned(e){e.isPinned?delete this.plugin.settings.pinnedModels[e.name]:this.plugin.settings.pinnedModels[e.name]=!0,await this.plugin.saveSettings(),this.refreshModels()}onChooseSuggestion(e,t){this.onResult.emit(e.name)}onOpen(){super.onOpen(),F(this.plugin.settings.connections).then()}onClose(){super.onClose(),this.unsubscribe(),sleep(0).then(()=>{this.onResult.emit(null)})}};function le(i){return(i.isPinned?"0":"1")+(i.isDefault?"0":"1")+i.connectionIndex+"_"+i.name}var Me=[/^dall-e/,/embedding/,/(^|-)tts(-|$)/,/^whisper-/];function Se(i){let s=i.defaults.model,e=i.pinnedModels,t=new Map,n=new Map;i.connections.forEach((r,a)=>{let l=S(r);t.set(l,Le(r.baseUrl)),n.set(l,a)});let o=[];for(let[r,a]of b){if(Me.some(p=>p.test(r)))continue;let l=t.get(a),d=n.get(a);l===void 0||d===void 0||o.push({connectionUrl:l,connectionIndex:d,name:r,isDefault:r===s,isPinned:e[r]??!1})}return o}function Le(i){return i.replace(/https?:\/\//,"")}var ce=require("obsidian"),T=class extends ce.AbstractInputSuggest{constructor(e,t){super(e,t);this.inputEl=t;this.folders=["/"].concat(this.app.vault.getAllFolders().map(n=>n.path))}folders;getSuggestions(e){let t=e.toLowerCase();return this.folders.filter(n=>n.toLowerCase().includes(t))}renderSuggestion(e,t){t.createEl("div",{text:e})}selectSuggestion(e){this.setValue(e);let t=new Event("input");this.inputEl.dispatchEvent(t),this.close()}};var E=class extends h.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}unsubscribe=v.on(()=>this.display());hide(){super.hide(),this.unsubscribe()}display(){let{containerEl:e}=this;e.empty(),new h.Setting(e).setName("LLM docs directory").setDesc("The directory where new LLM documents will be created").addText(n=>{n.setPlaceholder("path/to/directory").setValue(this.plugin.settings.docsDir).onChange(async o=>{this.plugin.settings.docsDir=o,await this.plugin.saveSettings()}),new T(this.app,n.inputEl)});let t={tab:"a new tab",splitVertical:"a new split (vertical)",splitHorizontal:"a new split (horizontal)",window:"a new window",replace:"an existing tab"};new h.Setting(e).setName("Create new documents in...").addDropdown(n=>n.addOptions(t).setValue(this.plugin.settings.defaults.docOpenMethod).onChange(async o=>{this.plugin.settings.defaults.docOpenMethod=o,await this.plugin.saveSettings()})),ae(e,this.plugin,()=>this.display()),new h.Setting(e).setName("Defaults").setHeading(),this.addDefaultModelSetting(e),new h.Setting(e).setName("Default system prompt").setDesc("The default system prompt for new LLM documents").addText(n=>n.setPlaceholder("System prompt").setValue(this.plugin.settings.defaults.systemPrompt).onChange(async o=>{this.plugin.settings.defaults.systemPrompt=o,await this.plugin.saveSettings()}))}addDefaultModelSetting(e){let t=async n=>{this.plugin.settings.defaults.model=n,await this.plugin.saveSettings()};new h.Setting(e).setName("Default model").setDesc("The default LLM model variant to use for new LLM documents").addButton(n=>{n.setButtonText("Select").onClick(async()=>{let o=await new y(this.app,this.plugin).openAndGetResult();o&&(await t(o),this.display())})}).addText(n=>{n.setValue(this.plugin.settings.defaults.model).onChange(async o=>t(o))})}};var O=class extends m.Plugin{settings;async onload(){await this.loadSettings(),ne(this),this.addRibbonIcon("bot","Create new LLM doc",()=>{this.createNewDoc()}),this.addCommand({id:"create",name:"Create new LLM document",callback:()=>this.createNewDoc()}),this.addCommand({id:"complete",name:"Complete LLM document",editorCallback:async(s,e)=>{e.file&&await this.completeDoc(s,e.file)}}),this.addCommand({id:"chat_with_current_document",name:"Chat with current document",editorCallback:async(s,e)=>{e.file&&await this.chatWithDoc(e.file)}}),this.addCommand({id:"change_model",name:"Change model used in current document",editorCallback:async(s,e)=>{if(!e.file)return;let t=await new y(this.app,this).openAndGetResult();t&&await this.app.fileManager.processFrontMatter(e.file,n=>{let o=n.model;t!==o&&(n.model=t,new m.Notice("Changed to "+t))})}}),this.addSettingTab(new E(this.app,this)),this.registerEditorExtension(re)}async completeDoc(s,e){if(x(e))return;X(e);let t,n=o=>{o.key==="Escape"&&(t.stop(),new m.Notice("Cancelling..."))};try{let o=this.app.workspace.getLeavesOfType("markdown").map(r=>{let a=r.view;return a.file===e?a:void 0}).filter(Boolean)[0];o&&await o.save(),t=await g.fromFile(this.app,e,this.settings.defaults),document.addEventListener("keydown",n),await t.complete(this.settings.connections,s)}catch(o){new m.Notice(o)}finally{document.removeEventListener("keydown",n)}Z(e)}async createNewDoc(s,e){let t=(0,m.normalizePath)(this.settings.docsDir);this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t);let n=new Date().toISOString().split("T")[0],o=null;for(let c=1;c<100;c++){let A=c.toString().padStart(2,"0"),N=`${t}/${n}_${A}_LLM.md`;if(!this.app.vault.getAbstractFileByPath(N)){o=N;break}}if(!o){new m.Notice("Couldn't create - maximum of 100 files per day reached");return}let{defaults:r}=this.settings;s=s??r.docOpenMethod,e=e??r.systemPrompt;let a=await g.create(this.app,o,{model:r.model},[...e.length?[{role:"system",content:e}]:[],{role:"user",content:""}]);await J(this.app.workspace,s).openFile(a.file);let p=this.app.workspace.activeEditor?.editor;if(p){p.focus(),p.setCursor({line:p.lastLine(),ch:0});let c=p.cm,A=new KeyboardEvent("keydown",{key:"i"});c.contentDOM.dispatchEvent(A)}}onunload(){}async loadSettings(){this.settings=Object.assign({},Y,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async chatWithDoc(s){let e=(0,m.normalizePath)(this.settings.docsDir),t=this.app.metadataCache.fileToLinktext(s,e);await this.createNewDoc("splitVertical",`The user is referencing a document named "${s.name}" with the following content: [[${t}]]`)}};0&&(module.exports={});

/* nosourcemap */